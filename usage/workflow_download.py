from jmcomic import *
from jmcomic.cl import JmcomicUI

# 下方填入你要下载的本子的id，一行一个，每行的首尾可以有空白字符
jm_albums = '''
JM539434
539434
JM624396
624396
JM624379
624379
JM315992
315992
JM338363
338363
JM276417
276417
JM275888
275888
JM276271
276271
JM274631
274631
JM271956
271956
JM253591
253591
JM292614
292614
JM457193
457193
JM275155
275155
JM274745
274745
JM271619
271619
JM272409
272409
JM229433
229433
JM231574
231574
JM251291
251291
JM270429
270429
JM273005
273005
JM269920
269920
JM288660
288660
JM314457
314457
JM518078
518078
JM521404
521404
JM270170
270170
JM270745
270745
JM270841
270841
JM270390
270390
JM138326
138326
JM202105
202105
JM219408
219408
JM270193
270193
JM208185
208185
JM368177
368177
JM512458
512458
JM186557
186557
JM592701
592701
JM263508
263508
JM498865
498865
JM213964
213964
JM223542
223542
JM263456
263456
JM414159
414159
JM441708
441708
JM441882
441882
JM479805
479805
JM484389
484389
JM259011
259011
JM259010
259010
JM259528
259528
JM597886
597886
JM245595
245595
JM257613
257613
JM563711
563711
JM256940
256940
JM256478
256478
JM463454
463454
JM321505
321505
JM254910
254910
JM254913
254913
JM254915
254915
JM255221
255221
JM428644
428644
JM34865
34865
JM59202
59202
JM255293
255293
JM255938
255938
JM444924
444924
JM457734
457734
JM255014
255014
JM619532
619532
JM186357
186357
JM420341
420341
JM253597
253597
JM253836
253836
JM105986
105986
JM251851
251851
JM251944
251944
JM425017
425017
JM511353
511353
JM250557
250557
JM349977
349977
JM26672
26672
JM4823
4823
JM246354
246354
JM499813
499813
JM148215
148215
JM246877
246877
JM37342
37342
JM103032
103032
JM248321
248321
JM369407
369407
JM177667
177667
JM496895
496895
JM245413
245413
JM245795
245795
JM249712
249712
JM288609
288609
JM9121
9121
JM17640
17640
JM37022
37022
JM194349
194349
JM196309
196309
JM207765
207765
JM231985
231985
JM241306
241306
JM245972
245972
JM250594
250594
JM251855
251855
JM294806
294806
JM293861
293861
JM246263
246263
JM439649
439649
JM309622
309622
JM333020
333020
JM270004
270004
JM244643
244643
JM243119
243119
JM243101
243101
JM10433
10433
JM62607
62607
JM20807
20807
JM149693
149693
JM226029
226029
JM243679
243679
JM248171
248171
JM313481
313481
JM397303
397303
JM483253
483253
JM529911
529911
JM620892
620892
JM243864
243864
JM215902
215902
JM235788
235788
JM240472
240472
JM258777
258777
JM266191
266191
JM467095
467095
JM178129
178129
JM211753
211753
JM225811
225811
JM242006
242006
JM613000
613000
JM127261
127261
JM129858
129858
JM148674
148674
JM179333
179333
JM188470
188470
JM241467
241467
JM262885
262885
JM271434
271434
JM369428
369428
JM379603
379603
JM392340
392340
JM392452
392452
JM449867
449867
JM533201
533201
JM570518
570518
JM37097
37097
JM40115
40115
JM40275
40275
JM123772
123772
JM121312
121312
JM178778
178778
JM241287
241287
JM553009
553009
JM240163
240163
JM423392
423392
JM239788
239788
JM362445
362445
JM193306
193306
JM239740
239740
JM238560
238560
JM37671
37671
JM4735
4735
JM26208
26208
JM237190
237190
JM231956
231956
JM231805
231805
JM220219
220219
JM232256
232256
JM232100
232100
JM9981
9981
JM550185
550185
JM418500
418500
JM231397
231397
JM230580
230580
JM230193
230193
JM229976
229976
JM230005
230005
JM229965
229965
JM229434
229434
JM229435
229435
JM229584
229584
JM229808
229808
JM227369
227369
JM226747
226747
JM225603
225603
JM225598
225598
JM224563
224563
JM223665
223665
JM224272
224272
JM224354
224354
JM222880
222880
JM222605
222605
JM222468
222468
JM222453
222453
JM221146
221146
JM221426
221426
JM221442
221442
JM221661
221661
JM221420
221420
JM221346
221346
JM221295
221295
JM221111
221111
JM220764
220764
JM220765
220765
JM220447
220447
JM220272
220272
JM219693
219693
JM219324
219324
JM219320
219320
JM218362
218362
JM218350
218350
JM217628
217628
JM217724
217724
JM218141
218141
JM217586
217586
JM217484
217484
JM217081
217081
JM216633
216633
JM216646
216646
JM216647
216647
JM215814
215814
JM215678
215678
JM215786
215786
JM215463
215463
JM215152
215152
JM214824
214824
JM214605
214605
JM196014
196014
JM214432
214432
JM214514
214514
JM214401
214401
JM214398
214398
JM214078
214078
JM214079
214079
JM213958
213958
JM213930
213930
JM213448
213448
JM213228
213228
JM212997
212997
JM213082
213082
JM212924
212924
JM212040
212040
JM211240
211240
JM210264
210264
JM209824
209824
JM209181
209181
JM209180
209180
JM208992
208992
JM208964
208964
JM208596
208596
JM207970
207970
JM208008
208008
JM208085
208085
JM207572
207572
JM207300
207300
JM207291
207291
JM207119
207119
JM207118
207118
JM207057
207057
JM206963
206963
JM206708
206708
JM206522
206522
JM206521
206521
JM205535
205535
JM205612
205612
JM203023
203023
JM202978
202978
JM202695
202695
JM201160
201160
JM201563
201563
JM201709
201709
JM201739
201739
JM202061
202061
JM200636
200636
JM200627
200627
JM200350
200350
JM200536
200536
JM200307
200307
JM199743
199743
JM199619
199619
JM198921
198921
JM198911
198911
JM198358
198358
JM198011
198011
JM198566
198566
JM198054
198054
JM196852
196852
JM195698
195698
JM196257
196257
JM195459
195459
JM195693
195693
JM195512
195512
JM194636
194636
JM194495
194495
JM194347
194347
JM193398
193398
JM192868
192868
JM192870
192870
JM193288
193288
JM191991
191991
JM191990
191990
JM191767
191767
JM191756
191756
JM191131
191131
JM191114
191114
JM190539
190539
JM188750
188750
JM188636
188636
JM188490
188490
JM188477
188477
JM188589
188589
JM187787
187787
JM188418
188418
JM185073
185073
JM182239
182239
JM181614
181614
JM181509
181509
JM181363
181363
JM181067
181067
JM181034
181034
JM181010
181010
JM180834
180834
JM180609
180609
JM180772
180772
JM180628
180628
JM180535
180535
JM180284
180284
JM180043
180043
JM179847
179847
JM179634
179634
JM178811
178811
JM178191
178191
JM178441
178441
JM178033
178033
JM178002
178002
JM177892
177892
JM168048
168048
JM160061
160061
JM152332
152332
JM154577
154577
JM151966
151966
JM151809
151809
JM151664
151664
JM151711
151711
JM151790
151790
JM151438
151438
JM151064
151064
JM151355
151355
JM150029
150029
JM150097
150097
JM149977
149977
JM149987
149987
JM149908
149908
JM149699
149699
JM149666
149666
JM149654
149654
JM149575
149575
JM148943
148943
JM149379
149379
JM148667
148667
JM148634
148634
JM148621
148621
JM148343
148343
JM148227
148227
JM148032
148032
JM148023
148023
JM147857
147857
JM147856
147856
JM147223
147223
JM146949
146949
JM147046
147046
JM147034
147034
JM71714
71714
JM146836
146836
JM146358
146358
JM146541
146541
JM146159
146159
JM146030
146030
JM146028
146028
JM145166
145166
JM145636
145636
JM145697
145697
JM145835
145835
JM145999
145999
JM144983
144983
JM144563
144563
JM144868
144868
JM144450
144450
JM143979
143979
JM143980
143980
JM144017
144017
JM143891
143891
JM143617
143617
JM143696
143696
JM142456
142456
JM141921
141921
JM141902
141902
JM141819
141819
JM141784
141784
JM141192
141192
JM140985
140985
JM140456
140456
JM139957
139957
JM139959
139959
JM140126
140126
JM139786
139786
JM139675
139675
JM139528
139528
JM139515
139515
JM139052
139052
JM139027
139027
JM138847
138847
JM138497
138497
JM138451
138451
JM137931
137931
JM137929
137929
JM138148
138148
JM137764
137764
JM137277
137277
JM137268
137268
JM137185
137185
JM137179
137179
JM137076
137076
JM137037
137037
JM136915
136915
JM136735
136735
JM136472
136472
JM136427
136427
JM136419
136419
JM136208
136208
JM135980
135980
JM135934
135934
JM135873
135873
JM135644
135644
JM135643
135643
JM135104
135104
JM134993
134993
JM133058
133058
JM133040
133040
JM132054
132054
JM131651
131651
JM130063
130063
JM129971
129971
JM129958
129958
JM129864
129864
JM125841
125841
JM125682
125682
JM125665
125665
JM124568
124568
JM125555
125555
JM124078
124078
JM124270
124270
JM124412
124412
JM123243
123243
JM122744
122744
JM122511
122511
JM122162
122162
JM122538
122538
JM122111
122111
JM122066
122066
JM122052
122052
JM121889
121889
JM121887
121887
JM121836
121836
JM121718
121718
JM121512
121512
JM121120
121120
JM120941
120941
JM120773
120773
JM121004
121004
JM118611
118611
JM118564
118564
JM118225
118225
JM116253
116253
JM117024
117024
JM117064
117064
JM113763
113763
JM114331
114331
JM114098
114098
JM113358
113358
JM112976
112976
JM112789
112789
JM113012
113012
JM113576
113576
JM113713
113713
JM110572
110572
JM110557
110557
JM106015
106015
JM105896
105896
JM105651
105651
JM105580
105580
JM105362
105362
JM105093
105093
JM105336
105336
JM104962
104962
JM104639
104639
JM104801
104801
JM104674
104674
JM104437
104437
JM104340
104340
JM104110
104110
JM104131
104131
JM103911
103911
JM103677
103677
JM101432
101432
JM104087
104087
JM620242
620242
JM103157
103157
JM102918
102918
JM103212
103212
JM101894
101894
JM101773
101773
JM101657
101657
JM101623
101623
JM102294
102294
JM101611
101611
JM101597
101597
JM101563
101563
JM101295
101295
JM100452
100452
JM100238
100238
JM100235
100235
JM99734
99734
JM99706
99706
JM99443
99443
JM99195
99195
JM98875
98875
JM98866
98866
JM99108
99108
JM99005
99005
JM99003
99003
JM97441
97441
JM97844
97844
JM97102
97102
JM96914
96914
JM96886
96886
JM96745
96745
JM96302
96302
JM96394
96394
JM96261
96261
JM96230
96230
JM96056
96056
JM95969
95969
JM95962
95962
JM95605
95605
JM95603
95603
JM95601
95601
JM95599
95599
JM95597
95597
JM95596
95596
JM95595
95595
JM95591
95591
JM95452
95452
JM95144
95144
JM95045
95045
JM95033
95033
JM93587
93587
JM93350
93350
JM92860
92860
JM93675
93675
JM93667
93667
JM92358
92358
JM92340
92340
JM91882
91882
JM92042
92042
JM92114
92114
JM91170
91170
JM91154
91154
JM90458
90458
JM90285
90285
JM90284
90284
JM90017
90017
JM88991
88991
JM89913
89913
JM88345
88345
JM86453
86453
JM87046
87046
JM87740
87740
JM85821
85821
JM85790
85790
JM85787
85787
JM85294
85294
JM84945
84945
JM84684
84684
JM84171
84171
JM84600
84600
JM83863
83863
JM83751
83751
JM83597
83597
JM83578
83578
JM93669
93669
JM83471
83471
JM83269
83269
JM82805
82805
JM82232
82232
JM82635
82635
JM82286
82286
JM81723
81723
JM81587
81587
JM81505
81505
JM80435
80435
JM80436
80436
JM80343
80343
JM80322
80322
JM80222
80222
JM80201
80201
JM80170
80170
JM80167
80167
JM80166
80166
JM80165
80165
JM79993
79993
JM79849
79849
JM79620
79620
JM79617
79617
JM78746
78746
JM78971
78971
JM78449
78449
JM78744
78744
JM78312
78312
JM78413
78413
JM78005
78005
JM77751
77751
JM77691
77691
JM77462
77462
JM76940
76940
JM77112
77112
JM76942
76942
JM76388
76388
JM75787
75787
JM75957
75957
JM75781
75781
JM75454
75454
JM74021
74021
JM73948
73948
JM73507
73507
JM74463
74463
JM74469
74469
JM73146
73146
JM72781
72781
JM72047
72047
JM70272
70272
JM70687
70687
JM71806
71806
JM70216
70216
JM70079
70079
JM70034
70034
JM69420
69420
JM68297
68297
JM569433
569433
JM68969
68969
JM67058
67058
JM66578
66578
JM62738
62738
JM62439
62439
JM62064
62064
JM61829
61829
JM61038
61038
JM60449
60449
JM60004
60004
JM59901
59901
JM59721
59721
JM59677
59677
JM59658
59658
JM57457
57457
JM56989
56989
JM56735
56735
JM54757
54757
JM55540
55540
JM51674
51674
JM50980
50980
JM52557
52557
JM52134
52134
JM50359
50359
JM50061
50061
JM50406
50406
JM49842
49842
JM49511
49511
JM49948
49948
JM49445
49445
JM49334
49334
JM49321
49321
JM49182
49182
JM49001
49001
JM48787
48787
JM47022
47022
JM48398
48398
JM47088
47088
JM48450
48450
JM46747
46747
JM46722
46722
JM46723
46723
JM46603
46603
JM46655
46655
JM46589
46589
JM46371
46371
JM46304
46304
JM46301
46301
JM46104
46104
JM46102
46102
JM46098
46098
JM45530
45530
JM45500
45500
JM45377
45377
JM45354
45354
JM45352
45352
JM44576
44576
JM44712
44712
JM44636
44636
JM43732
43732
JM43560
43560
JM42956
42956
JM42691
42691
JM43202
43202
JM43448
43448
JM41896
41896
JM41841
41841
JM41665
41665
JM41623
41623
JM41563
41563
JM41525
41525
JM41486
41486
JM41520
41520
JM41322
41322
JM41248
41248
JM40876
40876
JM40714
40714
JM40595
40595
JM40613
40613
JM40496
40496
JM40501
40501
JM40495
40495
JM40372
40372
JM40130
40130
JM40097
40097
JM39911
39911
JM39583
39583
JM39655
39655
JM39611
39611
JM39347
39347
JM39428
39428
JM39536
39536
JM39548
39548
JM39426
39426
JM38960
38960
JM39322
39322
JM38411
38411
JM38660
38660
JM38012
38012
JM37847
37847
JM38213
38213
JM38134
38134
JM37765
37765
JM37604
37604
JM37588
37588
JM37377
37377
JM37486
37486
JM37438
37438
JM37373
37373
JM36868
36868
JM36209
36209
JM36502
36502
JM35950
35950
JM35731
35731
JM35691
35691
JM35649
35649
JM35436
35436
JM35585
35585
JM35591
35591
JM35587
35587
JM35580
35580
JM35268
35268
JM35393
35393
JM35428
35428
JM35242
35242
JM35238
35238
JM34359
34359
JM34791
34791
JM34901
34901
JM34616
34616
JM34788
34788
JM34786
34786
JM34121
34121
JM34090
34090
JM33862
33862
JM33761
33761
JM33759
33759
JM33357
33357
JM33754
33754
JM33695
33695
JM33355
33355
JM33350
33350
JM33313
33313
JM33169
33169
JM33171
33171
JM32912
32912
JM32896
32896
JM32874
32874
JM32499
32499
JM32576
32576
JM32863
32863
JM32370
32370
JM32288
32288
JM32210
32210
JM32188
32188
JM32033
32033
JM32011
32011
JM31992
31992
JM31211
31211
JM30972
30972
JM30902
30902
JM30759
30759
JM30393
30393
JM30429
30429
JM30728
30728
JM30581
30581
JM30242
30242
JM30389
30389
JM30219
30219
JM29762
29762
JM30178
30178
JM29734
29734
JM29482
29482
JM29174
29174
JM29030
29030
JM29029
29029
JM29172
29172
JM28765
28765
JM28635
28635
JM28443
28443
JM28244
28244
JM28348
28348
JM28199
28199
JM28159
28159
JM28088
28088
JM27926
27926
JM27851
27851
JM27602
27602
JM27264
27264
JM26899
26899
JM26763
26763
JM26306
26306
JM26289
26289
JM26134
26134
JM26175
26175
JM26194
26194
JM26188
26188
JM25942
25942
JM26128
26128
JM26123
26123
JM25933
25933
JM25701
25701
JM25699
25699
JM25647
25647
JM24553
24553
JM24407
24407
JM24383
24383
JM24689
24689
JM24329
24329
JM24243
24243
JM24207
24207
JM24117
24117
JM23870
23870
JM23573
23573
JM23462
23462
JM23097
23097
JM22557
22557
JM22504
22504
JM22341
22341
JM22167
22167
JM22056
22056
JM21800
21800
JM21139
21139
JM21348
21348
JM21747
21747
JM20974
20974
JM20695
20695
JM20600
20600
JM20111
20111
JM20493
20493
JM20101
20101
JM20091
20091
JM20088
20088
JM19905
19905
JM19897
19897
JM19803
19803
JM19783
19783
JM19685
19685
JM19444
19444
JM19496
19496
JM18711
18711
JM18705
18705
JM19366
19366
JM18834
18834
JM18704
18704
JM18458
18458
JM18035
18035
JM17938
17938
JM17869
17869
JM17877
17877
JM17745
17745
JM17639
17639
JM17638
17638
JM17425
17425
JM17356
17356
JM17319
17319
JM17323
17323
JM17274
17274
JM16912
16912
JM16724
16724
JM16498
16498
JM16461
16461
JM16096
16096
JM15802
15802
JM15759
15759
JM15472
15472
JM15046
15046
JM14981
14981
JM14551
14551
JM14613
14613
JM14216
14216
JM14409
14409
JM13990
13990
JM14178
14178
JM13984
13984
JM13890
13890
JM13531
13531
JM13740
13740
JM13821
13821
JM13527
13527
JM13385
13385
JM13772
13772
JM13081
13081
JM12929
12929
JM13361
13361
JM12737
12737
JM12659
12659
JM12572
12572
JM12438
12438
JM12493
12493
JM12125
12125
JM12307
12307
JM12258
12258
JM11694
11694
JM11475
11475
JM11131
11131
JM11251
11251
JM11290
11290
JM11086
11086
JM11123
11123
JM10496
10496
JM10712
10712
JM9832
9832
JM9736
9736
JM9931
9931
JM10038
10038
JM10292
10292
JM9686
9686
JM9233
9233
JM9131
9131
JM8830
8830
JM8798
8798
JM8956
8956
JM8982
8982
JM8971
8971
JM9016
9016
JM8985
8985
JM8512
8512
JM8442
8442
JM8417
8417
JM8409
8409
JM8671
8671
JM8022
8022
JM7991
7991
JM7819
7819
JM7144
7144
JM6860
6860
JM6762
6762
JM6761
6761
JM6562
6562
JM6664
6664
JM5770
5770
JM5731
5731
JM5671
5671
JM5203
5203
JM5335
5335
JM4744
4744
JM4931
4931
JM5326
5326
JM4356
4356
JM4345
4345
JM4355
4355
JM3844
3844
JM4134
4134
JM3078
3078
JM3470
3470
JM3790
3790
JM3841
3841
JM3025
3025
JM2738
2738
JM2568
2568
JM2537
2537
JM1595
1595
JM1469
1469
JM1451
1451
JM1444
1444
JM1397
1397
JM1387
1387
JM1276
1276
JM1050
1050
JM1292
1292
JM1356
1356
JM943
943
JM750
750
JM115
115
JM1403
1403






















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































'''

# 单独下载章节
jm_photos = '''



'''


def env(name, default, trim=('[]', '""', "''")):
    import os
    value = os.getenv(name, None)
    if value is None or value == '':
        return default

    for pair in trim:
        if value.startswith(pair[0]) and value.endswith(pair[1]):
            value = value[1:-1]

    return value


def get_id_set(env_name, given):
    aid_set = set()
    for text in [
        given,
        (env(env_name, '')).replace('-', '\n'),
    ]:
        aid_set.update(str_to_set(text))

    return aid_set


def main():
    album_id_set = get_id_set('JM_ALBUM_IDS', jm_albums)
    photo_id_set = get_id_set('JM_PHOTO_IDS', jm_photos)

    helper = JmcomicUI()
    helper.album_id_list = list(album_id_set)
    helper.photo_id_list = list(photo_id_set)

    option = get_option()
    helper.run(option)
    option.call_all_plugin('after_download')


def get_option():
    # 读取 option 配置文件
    option = create_option(os.path.abspath(os.path.join(__file__, '../../assets/option/option_workflow_download.yml')))

    # 支持工作流覆盖配置文件的配置
    cover_option_config(option)

    # 把请求错误的html下载到文件，方便GitHub Actions下载查看日志
    log_before_raise()

    return option


def cover_option_config(option: JmOption):
    dir_rule = env('DIR_RULE', None)
    if dir_rule is not None:
        the_old = option.dir_rule
        the_new = DirRule(dir_rule, base_dir=the_old.base_dir)
        option.dir_rule = the_new

    impl = env('CLIENT_IMPL', None)
    if impl is not None:
        option.client.impl = impl

    suffix = env('IMAGE_SUFFIX', None)
    if suffix is not None:
        option.download.image.suffix = fix_suffix(suffix)


def log_before_raise():
    jm_download_dir = env('JM_DOWNLOAD_DIR', workspace())
    mkdir_if_not_exists(jm_download_dir)

    def decide_filepath(e):
        resp = e.context.get(ExceptionTool.CONTEXT_KEY_RESP, None)

        if resp is None:
            suffix = str(time_stamp())
        else:
            suffix = resp.url

        name = '-'.join(
            fix_windir_name(it)
            for it in [
                e.description,
                current_thread().name,
                suffix
            ]
        )

        path = f'{jm_download_dir}/【出错了】{name}.log'
        return path

    def exception_listener(e: JmcomicException):
        """
        异常监听器，实现了在 GitHub Actions 下，把请求错误的信息下载到文件，方便调试和通知使用者
        """
        # 决定要写入的文件路径
        path = decide_filepath(e)

        # 准备内容
        content = [
            str(type(e)),
            e.msg,
        ]
        for k, v in e.context.items():
            content.append(f'{k}: {v}')

        # resp.text
        resp = e.context.get(ExceptionTool.CONTEXT_KEY_RESP, None)
        if resp:
            content.append(f'响应文本: {resp.text}')

        # 写文件
        write_text(path, '\n'.join(content))

    JmModuleConfig.register_exception_listener(JmcomicException, exception_listener)


if __name__ == '__main__':
    main()
